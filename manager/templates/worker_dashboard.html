{% extends "base.html" %}
{% block title %}Worker Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-pc-display"></i> Worker Dashboard</h2>
    <span class="badge bg-success fs-6">Resource Provider</span>
</div>

<!-- Earnings Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="stat-value">{{ total_earnings }}</div>
            <div class="stat-label">Total Credits Earned</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="stat-value">{{ total_jobs }}</div>
            <div class="stat-label">Jobs Completed</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card info">
            <div class="stat-value">{{ workers|selectattr('status', 'equalto', 'online')|list|length }}</div>
            <div class="stat-label">Workers Online</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="stat-value">{{ stats.pending or 0 }}</div>
            <div class="stat-label">Jobs in Queue</div>
        </div>
    </div>
</div>

<!-- How to Connect -->
<div class="alert alert-info mb-4">
    <h5><i class="bi bi-info-circle"></i> Connect a Worker from Another Laptop</h5>
    <p class="mb-2">Run this command on any machine on your network to contribute compute resources and earn credits:</p>
    <pre class="bg-dark text-white p-3 rounded mb-2">python3 run_worker.py -m &lt;MANAGER_IP&gt; -n "MyWorker" -u {{ user.username }}</pre>
    <small class="text-muted">
        <strong>Note:</strong> Replace <code>&lt;MANAGER_IP&gt;</code> with the IP shown when you start the manager.
        Both machines must be on the same network (WiFi/LAN).
    </small>
</div>

<!-- My Workers -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-gear"></i> My Workers</span>
        <span class="badge bg-secondary">{{ workers|length }} registered</span>
    </div>
    <div class="card-body">
        {% if workers %}
        <div class="row">
            {% for worker in workers %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 {% if worker.status == 'offline' %}border-danger{% elif worker.status == 'online' %}border-success{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-pc-display"></i> {{ worker.name }}</span>
                        <span class="badge badge-status badge-{{ worker.status }}">{{ worker.status|upper }}</span>
                    </div>
                    <div class="card-body">
                        <p><strong>CPU:</strong> {{ worker.cpu_cores }} cores</p>
                        <p><strong>RAM:</strong> {{ worker.ram_gb }} GB</p>
                        {% if worker.gpu_name %}
                        <p><strong>GPU:</strong> {{ worker.gpu_name }}</p>
                        {% endif %}
                        <hr>
                        <p><strong>Jobs Completed:</strong> {{ worker.total_jobs_completed or 0 }}</p>
                        <p><strong>Credits Earned:</strong> <span class="text-success fw-bold">{{ worker.total_credits_earned or 0 }}</span></p>

                        <div class="d-flex gap-2 mt-3">
                            {% if worker.status == 'online' or worker.status == 'busy' %}
                            <form action="{{ url_for('pause_worker', worker_id=worker.id) }}" method="POST">
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="bi bi-pause-fill"></i> Pause
                                </button>
                            </form>
                            {% elif worker.status == 'paused' %}
                            <form action="{{ url_for('resume_worker', worker_id=worker.id) }}" method="POST">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-play-fill"></i> Resume
                                </button>
                            </form>
                            {% endif %}
                            <form action="{{ url_for('remove_worker', worker_id=worker.id) }}" method="POST"
                                  onsubmit="return confirm('Remove this worker?');">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        Last seen: {{ worker.last_heartbeat[:16] if worker.last_heartbeat else 'Never' }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-pc-display" style="font-size: 4rem; color: #ccc;"></i>
            <h4 class="mt-3">No Workers Registered</h4>
            <p class="text-muted">Connect a worker to start earning credits!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Network Status -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-activity"></i> Network Status
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <h3 class="text-primary">{{ stats.online_workers or 0 }}</h3>
                <p class="text-muted">Total Online Workers</p>
            </div>
            <div class="col-md-4">
                <h3 class="text-warning">{{ stats.running or 0 }}</h3>
                <p class="text-muted">Jobs Running</p>
            </div>
            <div class="col-md-4">
                <h3 class="text-info">{{ stats.pending or 0 }}</h3>
                <p class="text-muted">Jobs Waiting</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
